<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾®é†ºåœ–æ›¸é¤¨ | ç¸½ç®¡å¾Œå° (CMS)</title>
  <!-- å¼•å…¥ Bootstrap 5 èˆ‡åœ–ç¤º -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- èˆ‡å‰å°ä¸€è‡´çš„å„ªé›…å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --é»‘è‰²: #121212;
      --å¡ç‰‡èƒŒæ™¯è‰²: #1e1e1e;
      --å¥¢è¯é‡‘: #D4AF37;
      --æ¬¡è¦æ–‡å­—è‰²: #a0a0a0;
    }

    body {
      background-color: var(--é»‘è‰²);
      color: #f5f5f7;
      font-family: 'Noto Serif TC', serif;
    }

    /* ----- æ ¸å¿ƒé€šç”¨è¨­å®š (æ²¿ç”¨å‰å°é¢¨æ ¼) ----- */
    .é‡‘è‰²æ–‡å­— {
      color: var(--å¥¢è¯é‡‘);
    }

    .ç™½è‰²é€æ˜æ–‡å­— {
      color: rgba(255, 255, 255, 0.5);
    }

    .å¥¢è¯é‡‘å¡«æ»¿æŒ‰éˆ• {
      background-color: var(--å¥¢è¯é‡‘);
      color: #000;
      font-weight: bold;
      border: none;
      transition: 0.3s;
    }

    .å¥¢è¯é‡‘å¡«æ»¿æŒ‰éˆ•:hover {
      background-color: #c5a059;
      color: #000;
    }

    .å¥¢æ¯›ç»ç’ƒå¡ç‰‡ {
      background-color: rgba(26, 26, 26, 0.8) !important;
      backdrop-filter: blur(15px);
      border: 1px solid var(--å¥¢è¯é‡‘);
      color: #fff;
    }

    .æ¯›ç»ç’ƒè¼¸å…¥æ¡† {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(212, 175, 55, 0.3);
      color: #fff;
      transition: 0.3s;
    }

    .æ¯›ç»ç’ƒè¼¸å…¥æ¡†:focus {
      background-color: #222;
      border-color: var(--å¥¢è¯é‡‘);
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
      color: #fff;
    }

    /* å°è¦½åˆ—èˆ‡æ’ç‰ˆ */
    .é ‚éƒ¨æ§åˆ¶åˆ— {
      background: rgba(30, 30, 30, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* è¡¨æ ¼å„ªåŒ– (æ·±è‰²è¨­è¨ˆ) */
    .table-dark {
      --bs-table-bg: var(--å¡ç‰‡èƒŒæ™¯è‰²);
      --bs-table-striped-bg: #2a2a2a;
      border-color: #333;
    }

    td {
      vertical-align: middle;
    }

    /* åœ–ç‰‡å°ç¸®åœ– */
    .admin-img-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--å¥¢è¯é‡‘);
    }

    /* æ¨™ç±¤å°åœ–ç¤º */
    .æ™¶ç‰‡æ¨™ç±¤ {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.4);
      color: var(--å¥¢è¯é‡‘);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    /* è‡ªè¨‚ Modal Header / Footer ç·šæ¢ */
    .modal-header,
    .modal-footer {
      border-color: rgba(212, 175, 55, 0.2);
    }

    /* å…¨åŸŸé€šçŸ¥ (Toast) */
    #é€šçŸ¥æ¡† {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 20, 20, 0.95);
      color: #fff;
      padding: 15px 30px;
      border-radius: 50px;
      border: 1px solid var(--å¥¢è¯é‡‘);
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    /* åœ¨æš—è‰²èƒŒæ™¯ä¸­ï¼Œform-control çš„æ–‡å­—é¡è‰² */
    ::placeholder {
      color: rgba(255, 255, 255, 0.3) !important;
    }
  </style>
</head>

<body>

  <!-- é ‚éƒ¨å°è¦½åˆ— -->
  <div class="é ‚éƒ¨æ§åˆ¶åˆ—">
    <div class="container-fluid px-4 px-md-5">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h4 class="m-0 é‡‘è‰²æ–‡å­—" style="letter-spacing: 2px;">
          <i class="bi bi-gear-fill me-2"></i>å¾®é†ºåœ–æ›¸é¤¨ - ç¸½ç®¡å¾Œå°
        </h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-warning" onclick="å°å›é¦–é ()">
            <i class="bi bi-house-door me-1"></i> è¿”å›åœ–æ›¸é¤¨
          </button>
          <button class="btn btn-outline-secondary text-white" onclick="åŸ·è¡Œç™»å‡º()">
            <i class="bi bi-box-arrow-right me-1"></i> ç™»å‡º
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»æ§å°å€å¡Š -->
  <div class="container-fluid px-4 px-md-5 py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="text-white">é¤¨è—é…’è­œåˆ—è¡¨</h5>
      <button class="btn å¥¢è¯é‡‘å¡«æ»¿æŒ‰éˆ•" onclick="é–‹å•Ÿæ–°å¢æ¨¡å¼()">
        <i class="bi bi-plus-lg me-1"></i> æ–°å¢é…’è­œ
      </button>
    </div>

    <!-- å¡ç‰‡èˆ‡è¡¨æ ¼ -->
    <div class="card bg-transparent border-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle">
          <thead>
            <tr class="text-center" style="border-bottom: 2px solid var(--å¥¢è¯é‡‘);">
              <th>ID</th>
              <th>è¦–è¦º</th>
              <th>é…’å</th>
              <th>åŸºé…’ (Base)</th>
              <th>æ¿ƒåº¦ (ABV)</th>
              <th>é¢¨å‘³ (Taste)</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="é…’è­œåˆ—è¡¨å®¹å™¨" class="text-center">
            <tr>
              <td colspan="7" class="py-5 text-white-50">è¼‰å…¥é…’è­œè³‡æ–™ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ / ç·¨è¼¯ è¡¨å–®å½ˆçª— (Modal) -->
  <div class="modal fade" id="é…’è­œè¡¨å–®å½ˆçª—" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content å¥¢æ¯›ç»ç’ƒå¡ç‰‡">
        <div class="modal-header">
          <h5 class="modal-title é‡‘è‰²æ–‡å­—" id="è¡¨å–®æ¨™é¡Œ" style="font-weight: bold; letter-spacing: 2px;">æ–°å¢é…’è­œ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="é…’è­œè¡¨å–®">
            <!-- éš±è—çš„ MongoDB _id -->
            <input type="hidden" id="form-_id">

            <div class="row g-3">
              <div class="col-md-3">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">è‡ªè¨‚ ID å‹è™Ÿ</label>
                <input type="number" id="form-id" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="ä¾‹: 1 (é¸å¡«)">
              </div>
              <div class="col-md-9">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">é…’å (Name)</label>
                <input type="text" id="form-name" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" required
                  placeholder="ä¾‹: ç¶“å…¸é¦¬ä¸å°¼ Classic Martini">
              </div>

              <div class="col-md-4">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">åŸºé…’ (Base)</label>
                <input type="text" id="form-base" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="é™£åˆ—è«‹ä»¥é€—è™Ÿåˆ†éš” (ä¾‹: Gin,Vermouth)">
                <small class="text-white-50 ms-1" style="font-size: 0.75rem;">ä»¥åŠå½¢é€—é»åˆ†éš”å¤šé …</small>
              </div>
              <div class="col-md-4">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">æ¿ƒåº¦åˆ†é¡ (abvLevel)</label>
                <select id="form-abvLevel" class="form-select æ¯›ç»ç’ƒè¼¸å…¥æ¡† text-white">
                  <option style="color:black" value="low">low (ä½æ¿ƒåº¦)</option>
                  <option style="color:black" value="med">med (ä¸­ç­‰æ¿ƒåº¦)</option>
                  <option style="color:black" value="high">high (é«˜æ¿ƒåº¦)</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">æ¿ƒåº¦é¡¯ç¤º (abvDisplay)</label>
                <input type="text" id="form-abvDisplay" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="ä¾‹: 35%">
              </div>

              <div class="col-md-4">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">é¢¨å‘³ (Taste)</label>
                <select id="form-taste" class="form-select æ¯›ç»ç’ƒè¼¸å…¥æ¡† text-white">
                  <option style="color:black" value="é…¸ç”œ/æœé¦™">é…¸ç”œ/æœé¦™</option>
                  <option style="color:black" value="è¾›è¾£/ä¸ç”œ">è¾›è¾£/ä¸ç”œ</option>
                  <option style="color:black" value="æ¸…çˆ½/æ°£æ³¡">æ¸…çˆ½/æ°£æ³¡</option>
                  <option style="color:black" value="è‹¦ç”œ/å¤§äººå‘³">è‹¦ç”œ/å¤§äººå‘³</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">æŠ€æ³• (Method)</label>
                <input type="text" id="form-method" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="ä¾‹: Shake / Stir">
              </div>
              <div class="col-md-4">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">æ¯å‹ (Glass)</label>
                <input type="text" id="form-glass" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="ä¾‹: é¦¬ä¸å°¼æ¯">
              </div>

              <div class="col-12">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">ææ–™ (Ingredients)</label>
                <input type="text" id="form-ingredients" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="ä¾‹: ç´é…’ 60ml, è‹¦è‰¾é…’ 15ml">
              </div>

              <div class="col-12">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">åœ–ç‰‡ç¶²å€ (Image URL)</label>
                <input type="text" id="form-img" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" placeholder="https://...">
              </div>

              <div class="col-12">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">éˆé­‚æ•…äº‹ (Story)</label>
                <textarea id="form-story" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" rows="3" placeholder="èƒŒå¾Œçš„ä¸€æ®µæ•…äº‹..."></textarea>
              </div>

              <div class="col-12">
                <label class="ç™½è‰²é€æ˜æ–‡å­— mb-1">è£½ä½œç´°ç¯€ (Steps)</label>
                <textarea id="form-steps" class="form-control æ¯›ç»ç’ƒè¼¸å…¥æ¡†" rows="4"
                  placeholder="æ­¥é©Ÿä¸€&#10;æ­¥é©ŸäºŒ&#10;æ­¥é©Ÿä¸‰ (è«‹ä»¥æ›è¡Œåˆ†éš”)"></textarea>
                <small class="text-white-50 ms-1" style="font-size: 0.75rem;">è«‹ä½¿ç”¨æ›è¡Œç¬¦è™Ÿ(Enter)ä¾†å€åˆ†ä¸åŒæ­¥é©Ÿ</small>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary text-white" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn å¥¢è¯é‡‘å¡«æ»¿æŒ‰éˆ• px-4" id="å„²å­˜è¡¨å–®æŒ‰éˆ•" onclick="åŸ·è¡Œå„²å­˜()">å„²å­˜é…’è­œ</button>
        </div>
      </div>
    </div>
  </div>


  <!-- åˆªé™¤ç¢ºèªå½ˆçª— (Modal) -->
  <div class="modal fade" id="åˆªé™¤ç¢ºèªå½ˆçª—" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content å¥¢æ¯›ç»ç’ƒå¡ç‰‡">
        <div class="modal-header border-0">
          <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>è­¦å‘Š</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ç¢ºå®šè¦å¾é…’çª–ä¸­åˆªé™¤ <strong class="é‡‘è‰²æ–‡å­—" id="åˆªé™¤é…’åæç¤º"></strong> å—ï¼Ÿ<br>
          æ­¤æ“ä½œå°‡ç„¡æ³•å¾©åŸã€‚
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary text-white" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger px-4" id="ç¢ºèªåˆªé™¤æŒ‰éˆ•">ç¢ºèªåˆªé™¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥å°è¦–çª— -->
  <div id="é€šçŸ¥æ¡†"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // ğŸ› ï¸ CMS æ ¸å¿ƒé‚è¼¯
    // ==========================================

    const API_URL = "http://localhost:3000/api";
    let æ‰€æœ‰é…’è­œ = [];
    let ç·¨è¼¯ä¸­MongoDBçš„ID = null;

    // ã€å®‰å…¨é˜²è­·ã€‘é€²å…¥ç•«é¢å…ˆæª¢æŸ¥æ¬Šé™
    window.onload = function () {
      const token = localStorage.getItem('tipsy_token');
      const userStr = localStorage.getItem('tipsy_user');

      if (!token || !userStr) {
        alert("ç„¡æ†‘è­‰ï¼Œè«‹å…ˆç™»å…¥æœƒå“¡ã€‚å³å°‡å°å›é¦–é ï¼");
        window.location.href = "index.html";
        return;
      }

      const user = JSON.parse(userStr);
      if (user.role !== 'admin') {
        alert("æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯å¾®é†ºåœ–æ›¸é¤¨ç¸½ç®¡ï¼");
        window.location.href = "index.html";
        return;
      }

      // æŠ“å–é¤¨è—è³‡æ–™
      ç²å–æ‰€æœ‰é…’è­œ();
    };

    function å°å›é¦–é () {
      window.location.href = "index.html";
    }

    function åŸ·è¡Œç™»å‡º() {
      localStorage.removeItem('tipsy_token');
      localStorage.removeItem('tipsy_user');
      localStorage.removeItem('æˆ‘çš„æ”¶è—æ¸…å–®');
      å°å›é¦–é ();
    }

    // ==========================================
    // ğŸ“¡ API ä¸²æ¥æ®µè½
    // ==========================================

    async function ç²å–æ‰€æœ‰é…’è­œ() {
      try {
        const res = await fetch(`${API_URL}/cocktails`);
        æ‰€æœ‰é…’è­œ = await res.json();
        æ¸²æŸ“åˆ—è¡¨(æ‰€æœ‰é…’è­œ);
      } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—", err);
        é¡¯ç¤ºé€šçŸ¥("è³‡æ–™é€£ç·šç•°å¸¸");
      }
    }

    function æ¸²æŸ“åˆ—è¡¨(data) {
      const tbody = document.getElementById('é…’è­œåˆ—è¡¨å®¹å™¨');
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="py-5 text-white-50">é…’çª–ä¸­ç©ºç„¡ä¸€ç‰©ï¼Œå¿«å»æ–°å¢å§ã€‚</td></tr>`;
        return;
      }

      data.forEach(item => {
        // è™•ç† Base æ¨™ç±¤ rendering
        let baseYtml = '';
        if (Array.isArray(item.base)) {
          baseYtml = item.base.map(b => `<span class="æ™¶ç‰‡æ¨™ç±¤ me-1">${b}</span>`).join('');
        } else {
          baseYtml = `<span class="æ™¶ç‰‡æ¨™ç±¤">${item.base || 'ç„¡'}</span>`;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
                    <td class="text-white-50">#${item.id || '--'}</td>
                    <td>
                        <img src="${item.img || 'https://via.placeholder.com/60'}" class="admin-img-thumb" alt="æœªæœ‰åœ–ç‰‡">
                    </td>
                    <td class="é‡‘è‰²æ–‡å­— fw-bold">${item.name}</td>
                    <td>${baseYtml}</td>
                    <td class="text-white-50">${item.abvDisplay || '--'}</td>
                    <td class="text-white-50">${item.taste || '--'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning me-2" onclick="æº–å‚™ç·¨è¼¯('${item._id}')">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="æº–å‚™åˆªé™¤('${item._id}', '${item.name.replace(/'/g, "\\'")}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
        tbody.appendChild(tr);
      });
    }

    // ==========================================
    // âœï¸ è¡¨å–®æ“ä½œé‚è¼¯ (æ–°å¢ / ç·¨è¼¯)
    // ==========================================

    const è¡¨å–®å½ˆçª—å¥—ä»¶ = new bootstrap.Modal(document.getElementById('é…’è­œè¡¨å–®å½ˆçª—'));

    function æº–å‚™ç·¨è¼¯(id) {
      const æ‰¾åˆ°çš„é…’è­œç‰©ä»¶ = æ‰€æœ‰é…’è­œ.find(item => item._id === id);
      if (æ‰¾åˆ°çš„é…’è­œç‰©ä»¶) {
        é–‹å•Ÿç·¨è¼¯æ¨¡å¼(æ‰¾åˆ°çš„é…’è­œç‰©ä»¶);
      }
    }

    function é–‹å•Ÿæ–°å¢æ¨¡å¼() {
      ç·¨è¼¯ä¸­MongoDBçš„ID = null;
      document.getElementById('è¡¨å–®æ¨™é¡Œ').innerText = "æ–°å¢é…’è­œ";
      document.getElementById('é…’è­œè¡¨å–®').reset();
      // æ¸…é™¤éš±è—çš„ id ç¢ºä¿ä¹¾æ·¨
      document.getElementById('form-_id').value = '';
      è¡¨å–®å½ˆçª—å¥—ä»¶.show();
    }

    function é–‹å•Ÿç·¨è¼¯æ¨¡å¼(é…’è­œç‰©ä»¶) {
      ç·¨è¼¯ä¸­MongoDBçš„ID = é…’è­œç‰©ä»¶._id;
      document.getElementById('è¡¨å–®æ¨™é¡Œ').innerText = `ç·¨è¼¯: ${é…’è­œç‰©ä»¶.name}`;

      // å¡«å…¥è³‡æ–™
      document.getElementById('form-_id').value = é…’è­œç‰©ä»¶._id || '';
      document.getElementById('form-id').value = é…’è­œç‰©ä»¶.id || '';
      document.getElementById('form-name').value = é…’è­œç‰©ä»¶.name || '';

      // è™•ç†é™£åˆ—è½‰æ›å›æ–‡å­—
      document.getElementById('form-base').value = Array.isArray(é…’è­œç‰©ä»¶.base) ? é…’è­œç‰©ä»¶.base.join(', ') : (é…’è­œç‰©ä»¶.base || '');

      document.getElementById('form-abvLevel').value = é…’è­œç‰©ä»¶.abvLevel || 'med';
      document.getElementById('form-abvDisplay').value = é…’è­œç‰©ä»¶.abvDisplay || '';
      document.getElementById('form-taste').value = é…’è­œç‰©ä»¶.taste || 'é…¸ç”œ/æœé¦™';
      document.getElementById('form-method').value = é…’è­œç‰©ä»¶.method || '';
      document.getElementById('form-glass').value = é…’è­œç‰©ä»¶.glass || '';
      document.getElementById('form-ingredients').value = é…’è­œç‰©ä»¶.ingredients || '';
      document.getElementById('form-img').value = é…’è­œç‰©ä»¶.img || '';
      document.getElementById('form-story').value = é…’è­œç‰©ä»¶.story || '';

      // Steps å¯èƒ½æ˜¯é™£åˆ—ï¼Œå°‡å…¶ç”¨æ›è¡Œç¬¦ä¸²èµ·ä»¥ä¾¿ç·¨è¼¯
      document.getElementById('form-steps').value = Array.isArray(é…’è­œç‰©ä»¶.steps) ? é…’è­œç‰©ä»¶.steps.join('\n') : (é…’è­œç‰©ä»¶.steps || '');

      è¡¨å–®å½ˆçª—å¥—ä»¶.show();
    }

    async function åŸ·è¡Œå„²å­˜() {
      const token = localStorage.getItem('tipsy_token');
      const btn = document.getElementById('å„²å­˜è¡¨å–®æŒ‰éˆ•');

      // å–å‡ºæ¬„ä½ä¸¦è½‰ç‚ºç³»çµ±å°æ‡‰æ ¼å¼
      const rawBase = document.getElementById('form-base').value;
      const cleanBase = rawBase.split(',').map(s => s.trim()).filter(s => s); // è½‰é™£åˆ—

      const rawSteps = document.getElementById('form-steps').value;
      // æ”¯æ´ç”¨æ›è¡Œï¼Œæˆ–å¦‚æœæœ‰é€—è™Ÿä¹Ÿèƒ½åˆ†é–‹ (å„ªå…ˆä½¿ç”¨æ›è¡Œåˆ†é–‹)
      const cleanSteps = rawSteps.split(/\r?\n/).map(s => s.trim()).filter(s => s);

      const payloadData = {
        id: document.getElementById('form-id').value ? parseInt(document.getElementById('form-id').value) : undefined,
        name: document.getElementById('form-name').value,
        base: cleanBase, // array
        abvLevel: document.getElementById('form-abvLevel').value,
        abvDisplay: document.getElementById('form-abvDisplay').value,
        taste: document.getElementById('form-taste').value,
        method: document.getElementById('form-method').value,
        glass: document.getElementById('form-glass').value,
        ingredients: document.getElementById('form-ingredients').value,
        img: document.getElementById('form-img').value,
        story: document.getElementById('form-story').value,
        steps: cleanSteps // array
      };

      // åŸºç¤é©—è­‰
      if (!payloadData.name) {
        alert("è«‹è‡³å°‘å¡«å…¥ã€Œé…’åã€");
        return;
      }

      const methodType = ç·¨è¼¯ä¸­MongoDBçš„ID ? "PUT" : "POST";
      const targetUrl = ç·¨è¼¯ä¸­MongoDBçš„ID ? `${API_URL}/admin/cocktails/${ç·¨è¼¯ä¸­MongoDBçš„ID}` : `${API_URL}/admin/cocktails`;

      btn.disabled = true;
      btn.innerText = "å„²å­˜ä¸­...";

      try {
        const res = await fetch(targetUrl, {
          method: methodType,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // å¾Œç«¯é©—è­‰èº«ä»½
          },
          body: JSON.stringify(payloadData)
        });
        const data = await res.json();

        if (data.success) {
          é¡¯ç¤ºé€šçŸ¥(ç·¨è¼¯ä¸­MongoDBçš„ID ? "è³‡æ–™æ›´æ–°æˆåŠŸï¼" : "æ–°é…’è­œæˆåŠŸä¸Šæ¶ï¼");
          è¡¨å–®å½ˆçª—å¥—ä»¶.hide();
          await ç²å–æ‰€æœ‰é…’è­œ(); // é‡æ–°è¼‰å…¥
        } else {
          alert("å„²å­˜å¤±æ•—ï¼š" + (data.message || "æ¬Šé™ä¸è¶³æˆ–å…¶ä»–éŒ¯èª¤"));
        }
      } catch (err) {
        console.error("å„²å­˜å¤±æ•—", err);
        alert("é€£ç·šç³»çµ±ç•°å¸¸");
      } finally {
        btn.disabled = false;
        btn.innerText = "å„²å­˜é…’è­œ";
      }
    }

    // ==========================================
    // ğŸ—‘ï¸ åˆªé™¤æ“ä½œé‚è¼¯
    // ==========================================
    const åˆªé™¤ç¢ºèªå¥—ä»¶ = new bootstrap.Modal(document.getElementById('åˆªé™¤ç¢ºèªå½ˆçª—'));
    let å¾…åˆªé™¤ID = null;

    function æº–å‚™åˆªé™¤(mongoId, name) {
      å¾…åˆªé™¤ID = mongoId;
      document.getElementById('åˆªé™¤é…’åæç¤º').innerText = name;
      åˆªé™¤ç¢ºèªå¥—ä»¶.show();
    }

    document.getElementById('ç¢ºèªåˆªé™¤æŒ‰éˆ•').addEventListener('click', async function () {
      if (!å¾…åˆªé™¤ID) return;
      const token = localStorage.getItem('tipsy_token');
      const btn = this;
      btn.disabled = true;

      try {
        const res = await fetch(`${API_URL}/admin/cocktails/${å¾…åˆªé™¤ID}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (data.success) {
          é¡¯ç¤ºé€šçŸ¥("é…’è­œå·²è‡ªé…’çª–ä¸­ç§»é™¤");
          åˆªé™¤ç¢ºèªå¥—ä»¶.hide();
          await ç²å–æ‰€æœ‰é…’è­œ();
        } else {
          alert("åˆªé™¤å¤±æ•—ï¼š" + data.message);
        }
      } catch (err) {
        alert("åˆªé™¤æ™‚ç™¼ç”Ÿæ–·ç·š");
      } finally {
        btn.disabled = false;
        å¾…åˆªé™¤ID = null;
      }
    });

    // ==========================================
    // ğŸ’¬ å…±ç”¨å°å·¥å…· (Toast é€šçŸ¥)
    // ==========================================
    function é¡¯ç¤ºé€šçŸ¥(æ–‡å­—) {
      const box = document.getElementById("é€šçŸ¥æ¡†");
      box.textContent = æ–‡å­—;
      box.style.opacity = '1';
      setTimeout(() => {
        box.style.opacity = '0';
      }, 3000); // 3 ç§’å¾Œæ¼¸æ¼¸æ¶ˆå¤±
    }
  </script>
</body>

</html>